"use strict";(()=>{var p=class extends EventTarget{addEventListener(e,t,s){super.addEventListener(e,t,s)}removeEventListener(e,t,s){super.removeEventListener(e,t,s)}dispatchCustomEvent(e,t){return this.dispatchEvent(new CustomEvent(e,t))}};async function _(){let n=`${await betterncm.app.getDataPath()}/6K-Labs-Temp`;return await betterncm.fs.exists(n)||await betterncm.fs.mkdir(n),n}async function B(){return`${await _()}/${Date.now()}.tmp`}async function N(n,e={}){let{delay:t=200,times:s=15,shouldDelete:o=!0}=e;for(let i=0;;i+=1){if(i>=s)throw new Error("waitOutFile timeout");if(await betterncm.utils.delay(t),await betterncm.fs.exists(n))break}let c=async()=>(await betterncm.fs.readFileText(n).catch(i=>(console.error(i),""))).trim(),l="";for(let i=0;!l&&i<s&&(l=await c(),!l);i+=1)await betterncm.utils.delay(t);return o&&betterncm.fs.remove(n).catch(console.error),l}function E(n){return n.replaceAll("\\","/")}var A="bncm-6k-labs-server.exe",Y=1e4,M=3e3,D=2e3,W="bncm-6k-labs-server.pid";async function x(){return`${await _()}/${W}`}var S=class n extends p{constructor(t){super();this.pid=t}task=null;get running(){return!!this.task}promiseEndCallback=()=>{this.task&&(this.task=null,this.dispatchCustomEvent("stopped",{}))};start(t=0){this.task=betterncm.utils.delay(t).then(()=>this.waitForStop()).then(()=>this.promiseEndCallback(),s=>(console.error(s),this.promiseEndCallback()))}static async getStoredPID(){let t=await x();if(await betterncm.fs.exists(t))return(await betterncm.fs.readFileText(t)).trim()??void 0}static async killAllByName(){await betterncm.app.exec(`taskkill /F /IM ${A}`),console.log("Server killed (by name)")}static async restoreProc(){let t=await this.getStoredPID();if(t){let s=new n(t);if(await s.checkRunning())return s.start(D),s}}static async startNewProc(){let t=await this.restoreProc();if(t)return console.log("Server already running, skip start"),t;await this.killAllByName();let s=await x(),c=`${loadedPlugins["6k-labs"].pluginPath.replace("/./","/")}/${A}`;await betterncm.app.exec(`powershell -Command "(Start-Process -PassThru -WindowStyle Hidden -FilePath '${E(c)}').ID | Out-File -Encoding utf8 -FilePath '${E(s)}'"`);let l=await N(s,{shouldDelete:!1}),i=new n(l);return i.start(),console.log("Server started"),i}async checkRunning(){let t=await B();await betterncm.app.exec(`powershell -Command "((((Get-Process -Id ${this.pid}) 2> $null) -and $True) -or $False) | Out-File -Encoding utf8 -FilePath '${E(t)}'"`);let s=await N(t)==="True";if(!s){let o=await x();await betterncm.fs.exists(o)&&await betterncm.fs.remove(o)}return s}async waitForStop(){for(;await this.checkRunning();)await betterncm.utils.delay(D)}async kill(){this.task=null,await betterncm.app.exec(`taskkill /F /PID ${this.pid}`),await this.waitForStop(),this.dispatchCustomEvent("stopped",{}),console.log("Server killed")}};var k=class extends p{proc;lastStartTime=0;_starting=!1;_stopped=!0;_stopType=0;stoppedCallback=()=>{this._stopped?(this._stopType=0,console.log("Server stopped manually")):Date.now()-this.lastStartTime<Y?(this._stopped=!0,this._stopType=2,console.log("Server stopped too soon, will not restart")):this._stopType=1,this.dispatchCustomEvent("stopped",{detail:this._stopType}),this._stopType===1&&(console.log(`Server accidentally stopped, will retry in ${M} ms`),setTimeout(()=>{this._stopped||this.restart()},M))};get running(){return!!this.proc?.running}get stopped(){return this._stopped}get stopType(){return this._stopType}async restart(){if(!this._starting){this._starting=!0,await this.kill(),this._stopped=!1,this._stopType=0,this.lastStartTime=Date.now();try{this.proc=await S.startNewProc()}catch(e){this._starting=!1,console.error(e),this.kill(),this._stopType=3,this.dispatchCustomEvent("stopped",{detail:this._stopType});return}this.proc.addEventListener("stopped",this.stoppedCallback),this._starting=!1,this.dispatchCustomEvent("started",{})}}async kill(){this._stopped=!0,this.dispatchCustomEvent("beforeKill",{}),this.proc&&await this.proc.kill(),this.proc=void 0}},r=new k;var F={player:{hasSong:!1,isPaused:!0,volumePercent:0,seekbarCurrentPosition:0,seekbarCurrentPositionHuman:"0:00",statePercent:0,likeStatus:"INDEFFERENT",repeatType:"NONE"},track:{author:"",title:"",album:"",cover:"",duration:0,durationHuman:"0:00",url:"",id:"",isVideo:!1,isAdvertisement:!1,inLibrary:!1}};function R(n){let[e,t]=n.split(":").map(s=>parseInt(s,10));return e*60+t}var w=(n,...e)=>e.length===0?n:`${n}\uFF08${e[0]}\uFF09`;function q(n){let e=window.getComputedStyle(n);return e.display!=="none"&&e.visibility!=="hidden"}var L=class{query(){let e=betterncm.ncm.getPlayingSong();if(!e)return F;let t=[...document.querySelectorAll(".m-player")].find(q);if(!t)return F;let s=e.state===1,o=parseFloat(t.querySelector(".prg-spk .has.j-flag").style.height.replace(/%$/,"")),c=t.querySelector("time.now").innerText,l=R(c),i=parseFloat(t.querySelector(".prg-ply .has").style.width.replace(/%$/,""))/100,v=document.querySelector(".m-pinfo span.icn-loved")?"LIKE":"INDEFFERENT",g=t.querySelector("type.type-order")?"NONE":t.querySelector("type.type-one")?"ONE":"ALL",d=e.data.artists.map(y=>w(y.name,...y.tns??[],...y.trans?[y.trans]:[],...y.alias)).join(" / "),u=w(e.data.album.name,...e.data.album.transNames??[],...e.data.album.transName??[],...e.data.album.alias),m=w(e.data.name,...e.data.transNames??[],...e.data.alias),b=e.data.album.picUrl,P=t.querySelector("time.all").innerText,H=R(P),I=`${e.data.id}`,U=`https://music.163.com/song?id=${I}`;return{player:{hasSong:!0,isPaused:s,volumePercent:o,seekbarCurrentPosition:l,seekbarCurrentPositionHuman:c,statePercent:i,likeStatus:v,repeatType:g},track:{author:d,title:m,album:u,cover:b,duration:H,durationHuman:P,url:U,id:I,isVideo:!1,isAdvertisement:!1,inLibrary:!1}}}},O=new L;var C=9863,$=3e3;function z(n){return typeof n=="object"&&n!==null&&"type"in n&&"data"in n}var T=class extends p{ws;_stopped=!0;get connected(){return this.ws?.readyState===WebSocket.OPEN}get stopped(){return this._stopped}closeListener=e=>{this.dispatchCustomEvent("close",{}),!this._stopped&&(console.log(`Connection closed, reconnect in ${$}ms. code: ${e.code}, reason: ${e.reason}`),setTimeout(()=>{this._stopped||this.reconnect()},$))};createAnswerFunc(e,t){return s=>{let o={data:s,echo:t.echo};e.send(JSON.stringify(o))}}handle=e=>{let t;try{t=JSON.parse(e.data)}catch{console.error("Failed to parse message",e.data);return}if(!z(t)){console.error("Invalid message",t);return}this.dispatchCustomEvent(`api/${t.type}`,{detail:{ws:this.ws,data:t.data,answer:this.createAnswerFunc(this.ws,t)}})};shutdown(){this._stopped=!0,this.ws&&this.ws.readyState!==WebSocket.CLOSED&&(this.ws.removeEventListener("close",this.closeListener),this.ws.close(),console.log("Connection manually shutdown")),this.dispatchCustomEvent("close",{}),this.ws=void 0}reconnect(){this.shutdown(),this._stopped=!1,this.ws=new WebSocket(`ws://localhost:${C}/backend-connect`),this.ws.addEventListener("close",this.closeListener),this.ws.addEventListener("open",()=>{this.dispatchCustomEvent("open",{}),console.log("Connected to backend server")}),this.ws.addEventListener("message",this.handle)}},a=new T;a.addEventListener("api/query",n=>{let{answer:e}=n.detail;e(O.query())});function j(){let[n,e]=React.useState(a.connected),[t,s]=React.useState(a.stopped),[o,c]=React.useState(r.running),[l,i]=React.useState(r.stopped),[v,g]=React.useState(r.stopType),d=React.useCallback(()=>{e(!0),s(a.stopped)},[]),u=React.useCallback(()=>{e(!1),s(a.stopped)},[]),m=React.useCallback(()=>{c(!0),i(r.stopped),g(r.stopType)},[]),b=React.useCallback(()=>{c(!1),i(r.stopped),g(r.stopType)},[]);return React.useEffect(()=>(a.addEventListener("open",d),a.addEventListener("close",u),r.addEventListener("started",m),r.addEventListener("stopped",b),()=>{a.removeEventListener("open",d),a.removeEventListener("close",u),r.removeEventListener("started",m),r.removeEventListener("stopped",b)}),[d,u,m,b]),h("div",{style:{display:"flex",flexDirection:"column",gap:"8px",boxSizing:"border-box",width:"100%"}},h("h1",{style:{fontSize:"20px"}},"\u670D\u52A1\u72B6\u6001"),h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid rgba(136, 136, 136, 0.333)"}},h("div",null,"\u540E\u7AEF\u63A5\u53E3\u670D\u52A1"),h("div",{style:{textAlign:"right"}},h("span",{style:{color:o?"green":"red"}},o?"\u8FD0\u884C\u4E2D":l?v===0?"\u672A\u8FD0\u884C":"\u542F\u52A8\u5931\u8D25":"\u5C1D\u8BD5\u91CD\u542F\u4E2D"),l&&v!==0?h(f,null,h("br",null),h("span",{style:{color:"red"}},"\u7A0B\u5E8F\u5F02\u5E38\u9000\u51FA\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426 ",C," \u7AEF\u53E3\u88AB\u5360\u7528\u6216\u51FA\u73B0\u5176\u4ED6\u95EE\u9898")):null)),h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0"}},h("div",null,"\u524D\u7AEF\u4FE1\u606F\u67E5\u8BE2\u670D\u52A1"),h("div",null,h("span",{style:{color:n?"green":"red"}},n?"\u5DF2\u8FDE\u63A5":t?"\u5DF2\u505C\u6B62":"\u91CD\u8FDE\u4E2D"))),h("div",{style:{display:"flex",gap:"4px"}},h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>r.restart()},"\u91CD\u542F\u670D\u52A1"),h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>r.kill()},"\u505C\u6B62\u670D\u52A1")),h("h1",{style:{fontSize:"20px"}},"\u4F7F\u7528\u65B9\u5F0F"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u642D\u914D"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://6klabs.com")},"6klabs.com")," ","\u4F7F\u7528"),h("p",null,"\u767B\u5F55\u540E\u8FDB\u5165\u540E\u53F0\u9762\u677F\uFF0C\u70B9\u51FB Widgets\uFF0C\u518D\u70B9\u51FB Amuse\uFF0C\u4E4B\u540E\u9009\u62E9 Youtube Music\uFF0C\u590D\u5236 URL \u540E\u5411 OBS \u6DFB\u52A0\u6D4F\u89C8\u5668\u6E90\u5373\u53EF\uFF0C\u4F60\u4E5F\u53EF\u4EE5\u76F4\u63A5\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00\u9884\u89C8\u6548\u679C"),h("p",null,"\u4E0B\u65B9 Widget Settings \u4E2D\u8FD8\u53EF\u4EE5\u4FEE\u6539 Amuse \u7684\u6837\u5F0F")),h("h1",{style:{fontSize:"20px"}},"\u788E\u788E\u5FF5"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u4E00\u4E9B\u6CE8\u610F\u4E8B\u9879\uFF1A"),h("p",null,"- \u7531\u4E8E BetterNCM API \u9650\u5236\uFF0C\u540E\u7AEF\u670D\u52A1\u65E0\u6CD5\u968F\u7F51\u6613\u4E91\u5173\u95ED\uFF0C \u5982\u679C\u4E0D\u505C\u6B62\u4F1A\u4E00\u76F4\u7559\u5728\u540E\u53F0\uFF0C\u4E0D\u8FC7\u8D44\u6E90\u5360\u7528\u4E0D\u9AD8\uFF0C\u4E0D\u4ECB\u610F\u53EF\u4EE5\u4E0D\u7528\u7BA1\u5B83"),h("p",null,"- \u56E0\u4E3A\u672C\u5E9F\u7269\u5199\u7684\u72B6\u6001\u7BA1\u7406\u4EE3\u7801\u592A\u70C2\uFF0C\u4E0A\u9762\u4E24\u4E2A\u91CD\u542F\u548C\u505C\u6B62\u7684\u6309\u94AE\u6700\u597D\u4E0D\u8981\u70B9\u592A\u5FEB QAQ"),h("p",null,"- \u540E\u7AEF\u670D\u52A1\u5668\u5168\u90E8\u4EE3\u7801\u90FD\u662F\u4EA4\u7ED9 GitHub Copilot \u5199\u7684\uFF0C\u6211\u4E0D\u4F1A\u5199 Golang \u554A xwx")),h("h1",{style:{fontSize:"20px"}},"\u9E23\u8C22"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"- \u7075\u611F\u6765\u6E90\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/Widdit/now-playing-service")},"Widdit/now-playing-service")),h("p",null,"- \u670D\u52A1\u63D0\u4F9B\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://6klabs.com")},"6K Labs")),h("p",null,"- \u6280\u672F\u53C2\u8003\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/BetterNCM/InfinityLink")},"BetterNCM/InfinityLink")," ","&"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/std-microblock/LiveSongPlayer-MKII")},"std-microblock/LiveSongPlayer-MKII"))),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u6700\u540E\u795D\u5404\u4F4D\u4F7F\u7528\u6109\u5FEB\u5427~")),h("div",{style:{display:"flex",gap:"4px"}},h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>betterncm.ncm.openUrl("https://github.com/lgc2333/BetterNCM-6K-Labs/issues")},"\u524D\u5F80 GitHub Issues \u53CD\u9988 Bug \u6216\u63D0\u51FA\u5EFA\u8BAE")))}function K(){return h(j,null)}plugin.onConfig(()=>{let n=document.createElement("div");return ReactDOM.render(K(),n),n});plugin.onLoad(()=>{r.addEventListener("started",()=>{a.reconnect()}),r.addEventListener("beforeKill",()=>{a.shutdown()}),r.addEventListener("stopped",()=>{a.shutdown()}),r.restart()});})();
