"use strict";(()=>{var ee=Object.defineProperty;var te=(e,t)=>{for(var n in t)ee(e,n,{get:t[n],enumerable:!0})};var A={};te(A,{CommandFailedError:()=>x,TypedEventTarget:()=>d,captureScriptTemplate:()=>W,ensureCmdTmpDir:()=>H,ensureTmpDir:()=>E,escapePowershellInput:()=>u,genCmdTmpFilePath:()=>L,getCmdTmpDir:()=>P,getTmpDirPath:()=>T,prepareCommand:()=>K,randomChars:()=>C,removeCmdTmpDir:()=>k,removeTmpDir:()=>ne,runPowershellWithOutput:()=>v,waitForFunction:()=>y,waitOutFile:()=>j});async function T(){return`${await betterncm.app.getDataPath()}/6K-Labs-Temp`}async function ne(){let e=await T();await betterncm.fs.exists(e)&&await betterncm.fs.remove(e)}async function E(){let e=await T();return await betterncm.fs.exists(e)||await betterncm.fs.mkdir(e),e}async function y(e,t){let{delay:n=200,times:s=15,ignoreException:a=!0}=t??{};for(let i=0;s===0||i<s;i+=1){i!==0&&await betterncm.utils.delay(n);let o;try{o=await e()}catch(p){if(a){console.error(p);continue}throw p}if(o)return o}throw new Error("waitForFunction timeout")}function C(e){return Array.from({length:e},()=>String.fromCharCode(Math.floor(Math.random()*26)+97)).join("")}var W=`
$command = "{{command}}";
$filePath = "{{filePath}}";
$output = New-Object System.Text.StringBuilder;
try {
  $processOutput = Invoke-Expression $command 2>&1;
  $isSuccess = $?;
  $output.Append($processOutput -join "\`n");
} catch {
  $isSuccess = $False;
  $output.Append($_.Exception.Message);
};
$result = [PSCustomObject]@{
  success = $isSuccess;
  output  = ($output.ToString() -replace "\`r\`n", "\`n");
};
$result | ConvertTo-Json -Compress | Out-File -Encoding utf8 -FilePath $filePath;`.trim().replace(/\n\s*/g," ");function u(e){return`${e.replaceAll("`","``").replaceAll('"','`"')}`}function K(e,t){return W.replaceAll(`
`," ; ").replaceAll("{{command}}",u(e)).replaceAll("{{filePath}}",u(t))}async function j(e,t){let{delay:n=200,times:s=15,shouldDelete:a=!0}=t??{},i=await y(async()=>{if(await betterncm.fs.exists(e))return betterncm.fs.readFileText(e).then(o=>o.trim())},{delay:n,times:s});return a&&await y(async()=>(await betterncm.fs.remove(e),!await betterncm.fs.exists(e)),{delay:n,times:s}).catch(console.error),i}async function P(){return`${await E()}/commandCache`}async function H(){let e=await P();return await betterncm.fs.exists(e)||await betterncm.fs.mkdir(e),e}async function k(){let e=await P();await betterncm.fs.exists(e)&&await betterncm.fs.remove(e)}async function L(){return`${await H()}/${C(8)}.tmp`}var x=class extends Error{constructor(n,s){super(`A command failed: 
Command: ${n}
Output: ${s}`);this.command=n;this.output=s}name="CommandFailedError"};async function v(e,t){let{check:n=!0}=t??{},s=await L(),a=await L(),i=K(e,a);await betterncm.fs.writeFileText(s,i),await betterncm.app.exec(`powershell -Command "Get-Content -Path ${s} -Encoding utf8 | Invoke-Expression"`);let o;try{o=JSON.parse(await j(a))}catch(p){if(console.error(p),n)throw p;return{success:!1,output:`${p}`}}finally{await betterncm.fs.remove(s).catch(console.error)}if(n&&!o.success)throw new x(e,o.output);return o}var d=class extends EventTarget{addEventListener(t,n,s){super.addEventListener(t,n,s)}removeEventListener(t,n,s){super.removeEventListener(t,n,s)}dispatchCustomEvent(t,n){return this.dispatchEvent(new CustomEvent(t,n))}};var Y="bncm-6k-labs-server",U=`${Y}.exe`,N=1e4,q=3e3,se=2e3;async function re(e){let t=Object.entries(e).filter(([,i])=>i!==void 0).map(([i,o])=>`-${i} "${u(`${o}`)}"`).join(" ");if(!t)throw new Error("No query options");let{output:n}=await v(`Get-Process -ErrorAction SilentlyContinue ${t} | Select-Object ProcessName, Id | ConvertTo-Json -Compress`);if(!n)return[];let s=JSON.parse(n);return(Array.isArray(s)?s:[s]).map(i=>Object.fromEntries(Object.entries(i).map(([o,p])=>[o.toLowerCase(),p])))}async function oe(){await v(`Stop-Process -Name "${Y}" -Force`)}async function ie(){return`${loadedPlugins["6k-labs"].pluginPath.replace("/./","/")}/${U}`}async function ae(){return`${await E()}/${U}`}async function ce(){let e=await ie(),t=await ae();return await v(`Copy-Item -Path "${u(e)}" -Destination "${u(t)}"`),t}async function pe(){let{output:e}=await v(`(Start-Process -PassThru -WindowStyle Hidden -FilePath "${u(await ce())}").ID`);return parseInt(e,10)}var O=class extends d{constructor(n){super();this.pid=n;this._taskPromise=this.task()}_closed=!1;_taskPromise;get closed(){return this._closed}task(){let n=()=>{this._closed||(this.dispatchCustomEvent("stopped",{}),this._closed=!0)};return y(async()=>{let s=await re({id:this.pid});return this._closed||s.length===0},{delay:se,times:0,ignoreException:!1}).then(n,n)}close(){this._closed=!0}},_=class extends d{_processWatcher;_lastStartTime=0;_stopped=!0;_stopType=0;processStopCallback=()=>{if(!this._stopped){if(Date.now()-this._lastStartTime<N){this._stopType=2,this._stopped=!0,console.log("Server stopped too soon, will not restart"),this.dispatchCustomEvent("stopped",{detail:this._stopType});return}this._stopType=1,console.log(`Server accidentally stopped, will restart after ${q}ms`),this.dispatchCustomEvent("stopped",{detail:this._stopType}),setTimeout(()=>{this.restart()},q)}};get processRunning(){return this._processWatcher!==void 0&&!this._processWatcher.closed}get stopped(){return this._stopped}get stopType(){return this._stopType}async _restart(){let t=await pe();this._processWatcher=new O(t),this._lastStartTime=Date.now(),this._processWatcher.addEventListener("stopped",this.processStopCallback.bind(this))}async restart(){this.dispatchCustomEvent("starting",{});try{await this.kill(),this._stopped=!1,await this._restart()}catch(t){this._stopped=!0,this._stopType=3,console.error("Server start failed"),console.error(t),this.dispatchCustomEvent("stopped",{detail:this._stopType})}this.dispatchCustomEvent("started",{})}async kill(t=0){let n=this._stopped;this._stopped=!0,this._stopType=t,n||this.dispatchCustomEvent("beforeKill",{}),this._processWatcher&&(this._processWatcher.close(),this._processWatcher=void 0,console.log("ProcessWatcher closed")),await oe(),console.log("Server killed"),n||this.dispatchCustomEvent("stopped",{detail:this._stopType})}},r=new _;var z={player:{hasSong:!1,isPaused:!0,volumePercent:0,seekbarCurrentPosition:0,seekbarCurrentPositionHuman:"0:00",statePercent:0,likeStatus:"INDEFFERENT",repeatType:"NONE"},track:{author:"",title:"",album:"",cover:"",duration:0,durationHuman:"0:00",url:"",id:"",isVideo:!1,isAdvertisement:!1,inLibrary:!1}};function B(e){let[t,n]=e.split(":").map(s=>parseInt(s,10));return t*60+n}function I(e,...t){return t.length===0?e:`${e}\uFF08${t[0]}\uFF09`}function le(e){let t=window.getComputedStyle(e);return t.display!=="none"&&t.visibility!=="hidden"}var M=class{query(){let t=betterncm.ncm.getPlayingSong();if(!t)return z;let n=[...document.querySelectorAll(".m-player")].find(le);if(!n)return z;let s=t.state===1,a=parseFloat(n.querySelector(".prg-spk .has.j-flag").style.height.replace(/%$/,"")),i=n.querySelector("time.now").innerText,o=B(i),p=parseFloat(n.querySelector(".prg-ply .has").style.width.replace(/%$/,""))/100,g=document.querySelector(".m-pinfo span.icn-loved")?"LIKE":"INDEFFERENT",S=n.querySelector("type.type-order")?"NONE":n.querySelector("type.type-one")?"ONE":"ALL",m=t.data.artists.map(b=>I(b.name,...b.tns??[],...b.trans?[b.trans]:[],...b.alias)).join(" / "),l=I(t.data.album.name,...t.data.album.transNames??[],...t.data.album.transName??[],...t.data.album.alias),w=I(t.data.name,...t.data.transNames??[],...t.data.alias),G=t.data.album.picUrl,F=n.querySelector("time.all").innerText,X=B(F),R=`${t.data.id}`,Z=`https://music.163.com/song?id=${R}`;return{player:{hasSong:!0,isPaused:s,volumePercent:a,seekbarCurrentPosition:o,seekbarCurrentPositionHuman:i,statePercent:p,likeStatus:g,repeatType:S},track:{author:m,title:w,album:l,cover:G,duration:X,durationHuman:F,url:Z,id:R,isVideo:!1,isAdvertisement:!1,inLibrary:!1}}}},Q=new M;var D=9863,V=3e3;function ue(e){return typeof e=="object"&&e!==null&&"type"in e&&"data"in e}var $=class extends d{ws;_stopped=!0;get connected(){return this.ws?.readyState===WebSocket.OPEN}get stopped(){return this._stopped}closeListener=t=>{this.dispatchCustomEvent("close",{}),!this._stopped&&(console.log(`Connection closed, reconnect in ${V}ms. code: ${t.code}, reason: ${t.reason}`),setTimeout(()=>{this._stopped||this.reconnect()},V))};createAnswerFunc(t,n){return s=>{let a={data:s,echo:n.echo};t.send(JSON.stringify(a))}}handle=t=>{let n;try{n=JSON.parse(t.data)}catch{console.error("Failed to parse message",t.data);return}if(!ue(n)){console.error("Invalid message",n);return}this.dispatchCustomEvent(`api/${n.type}`,{detail:{ws:this.ws,data:n.data,answer:this.createAnswerFunc(this.ws,n)}})};shutdown(){this._stopped=!0,this.ws&&this.ws.readyState!==WebSocket.CLOSED&&(this.ws.removeEventListener("close",this.closeListener),this.ws.close(),console.log("Connection manually shutdown")),this.dispatchCustomEvent("close",{}),this.ws=void 0}reconnect(){this.shutdown(),this._stopped=!1,this.ws=new WebSocket(`ws://localhost:${D}/backend-connect`),this.ws.addEventListener("close",this.closeListener),this.ws.addEventListener("open",()=>{this.dispatchCustomEvent("open",{}),console.log("Connected to backend server")}),this.ws.addEventListener("message",this.handle)}},c=new $;c.addEventListener("api/query",e=>{let{answer:t}=e.detail;t(Q.query())});function de(){let[e,t]=React.useState(c.connected),[n,s]=React.useState(c.stopped),[a,i]=React.useState(r.processRunning),[o,p]=React.useState(r.stopped),[g,S]=React.useState(r.stopType),m=React.useCallback(()=>{t(c.connected),s(c.stopped)},[]),l=React.useCallback(()=>{i(r.processRunning),p(r.stopped),S(r.stopType)},[]);React.useEffect(()=>(c.addEventListener("open",m),c.addEventListener("close",m),r.addEventListener("starting",l),r.addEventListener("started",l),r.addEventListener("beforeKill",l),r.addEventListener("stopped",l),()=>{c.removeEventListener("open",m),c.removeEventListener("close",m),r.removeEventListener("starting",l),r.removeEventListener("started",l),r.removeEventListener("beforeKill",l),r.removeEventListener("stopped",l)}),[m,l]);let w={0:"\u7A0B\u5E8F\u672A\u542F\u52A8",1:"\u7A0B\u5E8F\u610F\u5916\u9000\u51FA",2:`\u7A0B\u5E8F\u5728\u8FC7\u77ED\u65F6\u95F4\u5185\u610F\u5916\u9000\u51FA (${N}ms)`,3:"\u542F\u52A8\u5931\u8D25"};return h("div",{style:{display:"flex",flexDirection:"column",gap:"8px",boxSizing:"border-box",width:"100%"}},h("h1",{style:{fontSize:"20px"}},"\u670D\u52A1\u72B6\u6001"),h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid rgba(136, 136, 136, 0.333)"}},h("div",null,"\u540E\u7AEF\u63A5\u53E3\u670D\u52A1"),h("div",{style:{textAlign:"right"}},h("span",{style:{color:a?"green":"red"}},a?"\u8FD0\u884C\u4E2D":o?g===0?"\u672A\u8FD0\u884C":"\u542F\u52A8\u5931\u8D25":"\u5C1D\u8BD5\u91CD\u542F\u4E2D"),o&&g!==0?h(f,null,h("br",null),h("span",{style:{color:"red"}},w[g],"\uFF0C\u8BF7\u68C0\u67E5\u662F\u5426 ",D," ","\u7AEF\u53E3\u88AB\u5360\u7528\u6216\u51FA\u73B0\u5176\u4ED6\u95EE\u9898")):null)),h("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"4px 0"}},h("div",null,"\u524D\u7AEF\u4FE1\u606F\u67E5\u8BE2\u670D\u52A1"),h("div",null,h("span",{style:{color:e?"green":"red"}},e?"\u5DF2\u8FDE\u63A5":n?"\u5DF2\u505C\u6B62":"\u91CD\u8FDE\u4E2D"))),h("div",{style:{display:"flex",gap:"4px"}},h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>r.restart()},"\u91CD\u542F\u670D\u52A1"),h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>r.kill()},"\u505C\u6B62\u670D\u52A1")),h("h1",{style:{fontSize:"20px"}},"\u4F7F\u7528\u65B9\u5F0F"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u642D\u914D"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://6klabs.com")},"6klabs.com")," ","\u4F7F\u7528"),h("p",null,"\u767B\u5F55\u540E\u8FDB\u5165\u540E\u53F0\u9762\u677F\uFF0C\u70B9\u51FB Widgets\uFF0C\u518D\u70B9\u51FB Amuse\uFF0C\u4E4B\u540E\u9009\u62E9 Youtube Music\uFF0C\u590D\u5236 URL \u540E\u5411 OBS \u6DFB\u52A0\u6D4F\u89C8\u5668\u6E90\u5373\u53EF\uFF0C\u4F60\u4E5F\u53EF\u4EE5\u76F4\u63A5\u5728\u6D4F\u89C8\u5668\u4E2D\u6253\u5F00\u9884\u89C8\u6548\u679C"),h("p",null,"\u4E0B\u65B9 Widget Settings \u4E2D\u8FD8\u53EF\u4EE5\u4FEE\u6539 Amuse \u7684\u6837\u5F0F")),h("h1",{style:{fontSize:"20px"}},"\u788E\u788E\u5FF5"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u4E00\u4E9B\u6CE8\u610F\u4E8B\u9879\uFF1A"),h("p",null,"- \u7531\u4E8E BetterNCM API \u9650\u5236\uFF0C\u540E\u7AEF\u670D\u52A1\u65E0\u6CD5\u968F\u7F51\u6613\u4E91\u5173\u95ED\uFF0C \u5982\u679C\u4E0D\u505C\u6B62\u4F1A\u4E00\u76F4\u7559\u5728\u540E\u53F0\uFF0C\u4E0D\u8FC7\u8D44\u6E90\u5360\u7528\u4E0D\u9AD8\uFF0C\u4E0D\u4ECB\u610F\u53EF\u4EE5\u4E0D\u7528\u7BA1\u5B83"),h("p",null,"- \u56E0\u4E3A\u672C\u5E9F\u7269\u5199\u7684\u72B6\u6001\u7BA1\u7406\u4EE3\u7801\u592A\u70C2\uFF0C\u4E0A\u9762\u4E24\u4E2A\u91CD\u542F\u548C\u505C\u6B62\u7684\u6309\u94AE\u6700\u597D\u4E0D\u8981\u70B9\u592A\u5FEB QAQ"),h("p",null,"- \u540E\u7AEF\u670D\u52A1\u5668\u5168\u90E8\u4EE3\u7801\u90FD\u662F\u4EA4\u7ED9 GitHub Copilot \u5199\u7684\uFF0C\u6211\u4E0D\u4F1A\u5199 Golang \u554A xwx")),h("h1",{style:{fontSize:"20px"}},"\u9E23\u8C22"),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"- \u7075\u611F\u6765\u6E90\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/Widdit/now-playing-service")},"Widdit/now-playing-service")),h("p",null,"- \u670D\u52A1\u63D0\u4F9B\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://6klabs.com")},"6K Labs")),h("p",null,"- \u6280\u672F\u53C2\u8003\uFF1A"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/BetterNCM/InfinityLink")},"BetterNCM/InfinityLink")," ","&"," ",h("a",{style:{textDecoration:"1px solid underline"},onClick:()=>betterncm.ncm.openUrl("https://github.com/std-microblock/LiveSongPlayer-MKII")},"std-microblock/LiveSongPlayer-MKII"))),h("div",{style:{display:"flex",flexDirection:"column",gap:"4px"}},h("p",null,"\u6700\u540E\u795D\u5404\u4F4D\u4F7F\u7528\u6109\u5FEB\u5427~")),h("div",{style:{display:"flex",gap:"4px"}},h("a",{className:"false u-ibtn5 u-ibtnsz8 cmd-button cmd-button-outlineSec cmd-button-size-m cmd-button-outline-sec button-item",style:{display:"flex",alignItems:"center",background:"transparent"},onClick:()=>betterncm.ncm.openUrl("https://github.com/lgc2333/BetterNCM-6K-Labs/issues")},"\u524D\u5F80 GitHub Issues \u53CD\u9988 Bug \u6216\u63D0\u51FA\u5EFA\u8BAE")))}function J(){return h(de,null)}function me(){console.log("6K-Labs dev mode enabled"),globalThis.SixKLabs={utils:A}}plugin.onConfig(()=>{let e=document.createElement("div");return ReactDOM.render(J(),e),e});plugin.onLoad(async e=>{await k().catch(console.error),r.addEventListener("started",()=>{c.reconnect()}),r.addEventListener("beforeKill",()=>{c.shutdown()}),r.addEventListener("stopped",()=>{c.shutdown()})});plugin.onAllPluginsLoaded(()=>{r.restart(),loadedPlugins["6k-labs"].devMode&&me()});})();
